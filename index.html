<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lodge Financial Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .balance-positive {
            color: #10b981; /* Green-500 */
        }
        .balance-negative {
            color: #ef4444; /* Red-500 */
        }
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input, .input-group select {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="flex justify-between items-center container mx-auto">
            <h1 class="text-xl font-bold text-gray-800">Lodge Financial Admin</h1>
            <span id="auth-status" class="text-sm text-gray-500">Status: Connecting...</span>
        </div>
    </div>

    <div class="bg-gray-100 p-2 shadow-inner sticky top-16 z-10">
        <div class="flex justify-around container mx-auto" id="tab-controls">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="roster">Dues Roster</button>
            <button class="tab-button" data-tab="expenses">Expenses</button>
        </div>
    </div>

    <main class="container mx-auto mt-4">

        <!-- Tab Content Containers -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Financial Summary Card -->
                <div class="card p-4 col-span-1 md:col-span-2">
                    <h2 class="text-lg font-semibold mb-3 border-b pb-2">Financial Summary</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-gray-700">
                            <span>Total Dues Collected:</span>
                            <span id="total-dues" class="font-bold text-lg text-blue-600">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-gray-700">
                            <span>Total Expenses:</span>
                            <span id="total-expenses" class="font-bold text-lg text-red-500">-$0.00</span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t">
                            <span class="text-xl font-bold">Net Balance:</span>
                            <span id="net-balance" class="text-2xl font-extrabold balance-positive">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Expense Form Card -->
                <div class="card p-4 col-span-1">
                    <h2 class="text-lg font-semibold mb-3 border-b pb-2">Record New Expense</h2>
                    <form id="expense-form" class="space-y-3">
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                            <input type="number" step="0.01" id="expense-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="expense-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="expense-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                            Record Expense
                        </button>
                    </form>
                </div>
            </div>

            <!-- Recent Activity Table (Placeholder) -->
            <div class="card p-4 mt-6">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Recent Expenses</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Description</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recent-expenses-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="3" class="px-3 py-2 text-center text-sm text-gray-500">Loading recent expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="expense-message" class="mt-2 text-sm text-center text-gray-500 hidden">Showing last 5 expenses.</p>
            </div>

        </div>

        <div id="roster-tab" class="tab-content hidden">
            <!-- Dues Roster and Member Management -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Dues Roster</h2>
                
                <!-- Add Member Form -->
                <form id="add-member-form" class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-md font-medium mb-3">Add New Member</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="member-name" placeholder="Member Name" class="p-2 border rounded-md flex-grow" required>
                        <input type="number" id="annual-dues" placeholder="Annual Dues ($)" step="1" class="p-2 border rounded-md w-full sm:w-1/3" required value="100">
                        <button type="submit" class="py-2 px-4 rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition">Add Member</button>
                    </div>
                </form>

                <!-- Roster Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Name</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Dues</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Paid This Year</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dues-roster-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-3 py-2 text-center text-sm text-gray-500">Loading roster...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="expenses-tab" class="tab-content hidden">
            <!-- Expense History -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Full Expense History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Description</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="full-expenses-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-3 py-2 text-center text-sm text-gray-500">Loading all expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal for Confirmations/Messages -->
    <div id="app-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirmation</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">Confirm</button>
            </div>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL VARIABLES ---
    let app, db, auth, userId = null;
    let isAuthReady = false;

    // Static App ID for the public collection path
    const appId = 'lodge-admin-tool'; 

    // YOUR REAL FIREBASE CONFIGURATION (Replaced with your actual values)
    const firebaseConfig = {
        apiKey: "AIzaSyBAYN5FX3snNSLDjcxnjT1...", // <<< YOUR REAL KEY
        authDomain: "hezekiah-lodge-admin.firebaseapp.com",
        projectId: "hezekiah-lodge-admin",
        storageBucket: "hezekiah-lodge-admin.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:a1b2c3d4e5f6g7h8"
    };

    // Check if configuration is dummy and block app if so
    if (firebaseConfig.apiKey.includes("DUMMY")) {
        showFatalError("DUMMY CONFIGURATION LOADED. Replace DUMMY_API_KEY with your actual Firebase API Key to enable saving data.");
        return;
    }
    
    // Global State & Initialization
    const authStatusEl = document.getElementById('auth-status');

    // --- UTILITIES ---

    // Simple Modal/Confirmation
    const modalEl = document.getElementById('app-modal');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMessageEl = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    function showModal(title, message, onConfirm) {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalEl.classList.remove('hidden');

        // Clear previous listeners
        modalConfirmBtn.onclick = null;
        modalCancelBtn.onclick = null;

        // Set new listeners
        modalConfirmBtn.onclick = () => {
            onConfirm();
            modalEl.classList.add('hidden');
        };
        modalCancelBtn.onclick = () => {
            modalEl.classList.add('hidden');
        };
    }

    function showFatalError(message) {
        document.querySelector('main').innerHTML = `
            <div class="card p-8 text-center bg-red-50 text-red-600">
                <p class="text-xl font-bold mb-4">FATAL ERROR: ${message}</p>
                <p class="text-sm">Please check the console for debugging information.</p>
            </div>
        `;
        authStatusEl.textContent = "Status: Error";
        console.error("FATAL ERROR:", message);
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
        }).format(amount);
    }

    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
    
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        console.log("Firebase App Initialized.");
    } catch (e) {
        showFatalError("Firebase configuration is missing or invalid.");
        console.error("Firebase Initialization Error:", e);
        return;
    }

    async function authenticate() {
        try {
            authStatusEl.textContent = "Status: Authenticating...";
            await signInAnonymously(auth);
            // onAuthStateChanged will handle the rest
        } catch (error) {
            authStatusEl.textContent = "Status: Auth failed. Check console.";
            console.error("Authentication Error:", error.code, error.message);
            showFatalError(`Authentication failed. Code: ${error.code}`);
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            isAuthReady = true;
            authStatusEl.textContent = `Status: Logged in (User ID: ${userId.substring(0, 8)}...)`;
            console.log("User signed in anonymously. UID:", userId);
            
            // Start listening for data now that we have a user
            setupAllListeners();

        } else {
            // User is signed out, or failed to sign in
            userId = null;
            isAuthReady = false;
            authStatusEl.textContent = "Status: Signed out.";
        }
    });

    authenticate(); // Kick off the process


    // --- FIREBASE PATHS ---

    // Public collection path: /artifacts/{appId}/public/data/
    function getPublicCollectionRef(collectionName) {
        return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
    }
    
    // --- DATA LISTENERS AND RENDERING ---

    function setupAllListeners() {
        if (!isAuthReady) return;
        
        setupFinancialSummaryListener();
        setupRosterListener();
        setupExpenseHistoryListener();
    }

    // 1. FINANCIAL SUMMARY (Dashboard & Totals)

    let totalDues = 0;
    let totalExpenses = 0;

    function setupFinancialSummaryListener() {
        // Listen for all dues
        const rosterRef = getPublicCollectionRef('members');
        onSnapshot(rosterRef, (snapshot) => {
            totalDues = 0;
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                if (data.paidThisYear) {
                    totalDues += data.paidThisYear;
                }
            });
            renderFinancialSummary();
        }, (error) => console.error("Dues Listener Error:", error));

        // Listen for all expenses
        const expensesRef = getPublicCollectionRef('expenses');
        onSnapshot(expensesRef, (snapshot) => {
            totalExpenses = 0;
            const expensesData = [];
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                totalExpenses += data.amount;
                expensesData.push({...data, id: doc.id});
            });
            renderFinancialSummary();
            renderRecentExpenses(expensesData);
        }, (error) => console.error("Expenses Listener Error:", error));
    }

    function renderFinancialSummary() {
        const netBalance = totalDues - totalExpenses;
        
        document.getElementById('total-dues').textContent = formatCurrency(totalDues);
        document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);

        const netBalanceEl = document.getElementById('net-balance');
        netBalanceEl.textContent = formatCurrency(netBalance);
        
        // Highlight balance color
        netBalanceEl.classList.remove('balance-positive', 'balance-negative');
        if (netBalance >= 0) {
            netBalanceEl.classList.add('balance-positive');
        } else {
            netBalanceEl.classList.add('balance-negative');
        }
    }

    function renderRecentExpenses(expensesData) {
        const body = document.getElementById('recent-expenses-body');
        body.innerHTML = '';

        // Sort by date/timestamp descending and show top 5
        const sortedExpenses = expensesData.sort((a, b) => 
            (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)
        ).slice(0, 5);

        if (sortedExpenses.length === 0) {
            body.innerHTML = `<tr><td colspan="3" class="px-3 py-2 text-center text-sm text-gray-500">No expenses recorded yet.</td></tr>`;
            document.getElementById('expense-message').classList.add('hidden');
            return;
        }

        sortedExpenses.forEach(expense => {
            const date = expense.timestamp ? new Date(expense.timestamp.toMillis()).toLocaleDateString() : 'N/A';
            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-700">${expense.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-red-500">
                        -${formatCurrency(expense.amount)}
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });
        document.getElementById('expense-message').classList.remove('hidden');
    }

    // 2. ROSTER (DUES) MANAGEMENT

    function setupRosterListener() {
        const rosterRef = getPublicCollectionRef('members');
        onSnapshot(rosterRef, (snapshot) => {
            const rosterData = [];
            snapshot.docs.forEach(doc => {
                rosterData.push({...doc.data(), id: doc.id});
            });
            renderRoster(rosterData);
        }, (error) => console.error("Roster Listener Error:", error));
    }

    function renderRoster(rosterData) {
        const body = document.getElementById('dues-roster-body');
        body.innerHTML = '';

        if (rosterData.length === 0) {
            body.innerHTML = `<tr><td colspan="5" class="px-3 py-2 text-center text-sm text-gray-500">No members added yet.</td></tr>`;
            return;
        }

        rosterData.forEach(member => {
            const statusClass = member.paidThisYear >= member.annualDues ? 'text-green-600 font-semibold' : 'text-red-500';
            const statusText = member.paidThisYear >= member.annualDues ? 'PAID' : 'DUE';
            
            const remainingDue = member.annualDues - (member.paidThisYear || 0); // Use 0 if paidThisYear is null/undefined
            const payButtonText = remainingDue > 0 ? `Pay ${formatCurrency(remainingDue)}` : 'Full Payment';

            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${member.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-700">${formatCurrency(member.annualDues)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-blue-600 font-medium">${formatCurrency(member.paidThisYear || 0)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center ${statusClass}">${statusText}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center">
                        <button data-id="${member.id}" data-due="${remainingDue}" class="pay-dues-btn py-1 px-3 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 transition disabled:opacity-50" ${remainingDue <= 0 ? 'disabled' : ''}>
                            ${payButtonText}
                        </button>
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });

        // Add event listeners for pay buttons
        document.querySelectorAll('.pay-dues-btn').forEach(button => {
            button.addEventListener('click', function() {
                const memberId = this.dataset.id;
                const remainingDue = parseFloat(this.dataset.due);
                handleDuesPayment(memberId, remainingDue);
            });
        });
    }
    
    async function handleDuesPayment(memberId, remainingDue) {
        if (!isAuthReady) return;

        showModal(
            "Record Dues Payment", 
            `Confirm receipt of ${formatCurrency(remainingDue)} from this member.`,
            async () => {
                try {
                    const memberDocRef = doc(getPublicCollectionRef('members'), memberId);
                    const currentData = (await getDoc(memberDocRef)).data();
                    const newPaidTotal = (currentData.paidThisYear || 0) + remainingDue;

                    await updateDoc(memberDocRef, {
                        paidThisYear: newPaidTotal,
                        lastPaid: serverTimestamp()
                    });
                    console.log("Dues payment recorded successfully.");
                } catch (e) {
                    console.error("Error recording dues payment:", e);
                    showModal("Error", "Could not record payment. Check console for details.", () => {});
                }
            }
        );
    }
    
    // 3. EXPENSE HISTORY (Full List)

    function setupExpenseHistoryListener() {
        const expensesRef = getPublicCollectionRef('expenses');
        // Fetch all expenses, sorted by timestamp
        const q = query(expensesRef);

        onSnapshot(q, (snapshot) => {
            const expensesData = [];
            snapshot.docs.forEach(doc => {
                expensesData.push({...doc.data(), id: doc.id});
            });
            // Sort in-memory (descending) as Firestore ordering requires indexes we avoid
            expensesData.sort((a, b) => 
                (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)
            );
            renderFullExpenseHistory(expensesData);
        }, (error) => console.error("Full Expenses Listener Error:", error));
    }

    function renderFullExpenseHistory(expensesData) {
        const body = document.getElementById('full-expenses-body');
        body.innerHTML = '';

        if (expensesData.length === 0) {
            body.innerHTML = `<tr><td colspan="4" class="px-3 py-2 text-center text-sm text-gray-500">No expenses recorded yet.</td></tr>`;
            return;
        }

        expensesData.forEach(expense => {
            const date = expense.timestamp ? new Date(expense.timestamp.toMillis()).toLocaleDateString() : 'N/A';
            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-700">${expense.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-red-500">
                        -${formatCurrency(expense.amount)}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center">
                        <button data-id="${expense.id}" class="delete-expense-btn text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H4.25a.75.75 0 0 0 0 1.5h.5c.343 0 .67.142.905.39l.006.007.41 1.708a2.5 2.5 0 0 0 4.658 0l.41-1.708.006-.007a1.751 1.751 0 0 0 .905-.39h.5a.75.75 0 0 0 0-1.5H14v-.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM9 3.75v.5h2v-.5A1.25 1.25 0 0 0 9.75 2.5h-1.5A1.25 1.25 0 0 0 7 3.75v.5h2Zm-3.25 7a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H5.75Zm9.25 0a.75.75 0 0 0 0 1.5h-.008a.75.75 0 0 0 0-1.5H15Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-expense-btn').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.dataset.id;
                confirmDeleteExpense(expenseId);
            });
        });
    }

    function confirmDeleteExpense(expenseId) {
        if (!isAuthReady) return;

        showModal(
            "Confirm Deletion",
            "Are you sure you want to permanently delete this expense record?",
            async () => {
                try {
                    const expenseDocRef = doc(getPublicCollectionRef('expenses'), expenseId);
                    await deleteDoc(expenseDocRef);
                    console.log("Expense deleted successfully.");
                } catch (e) {
                    console.error("Error deleting expense:", e);
                    showModal("Error", "Could not delete expense. Check console for details.", () => {});
                }
            }
        );
    }

    // --- FORM SUBMISSIONS ---

    // Expense Form
    document.getElementById('expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isAuthReady) return;

        const amount = parseFloat(document.getElementById('expense-amount').value);
        const description = document.getElementById('expense-description').value.trim();

        if (amount <= 0 || !description) {
            showModal("Error", "Please enter a valid amount and description.", () => {});
            return;
        }

        try {
            await addDoc(getPublicCollectionRef('expenses'), {
                amount: amount,
                description: description,
                timestamp: serverTimestamp(),
                recordedBy: userId
            });
            this.reset();
            console.log("Expense recorded successfully.");
        } catch (e) {
            console.error("Error recording expense:", e);
            showModal("Error", "Could not record expense. Check console for details.", () => {});
        }
    });

    // Add Member Form
    document.getElementById('add-member-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isAuthReady) return;

        const name = document.getElementById('member-name').value.trim();
        const annualDues = parseFloat(document.getElementById('annual-dues').value);

        if (!name || annualDues <= 0) {
            showModal("Error", "Please enter a valid member name and annual dues amount.", () => {});
            return;
        }

        try {
            // Check if member already exists (simple name check)
            const membersRef = getPublicCollectionRef('members');
            const q = query(membersRef, where('name', '==', name));
            const existing = await getDocs(q);

            if (!existing.empty) {
                showModal("Error", `A member named "${name}" already exists.`, () => {});
                return;
            }

            await addDoc(membersRef, {
                name: name,
                annualDues: annualDues,
                paidThisYear: 0,
                joinedDate: serverTimestamp()
            });
            this.reset();
            console.log("Member added successfully.");
        } catch (e) {
            console.error("Error adding member:", e);
            showModal("Error", "Could not add member. Check console for details.", () => {});
        }
    });


    // --- UI/TAB LOGIC ---
    document.getElementById('tab-controls').addEventListener('click', function(e) {
        const target = e.target.closest('.tab-button');
        if (!target) return; // Exit if the click wasn't on a button

        const tabName = target.dataset.tab;

        // 1. Update button active state
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');

        // 2. Show/Hide tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        // The fix is here: we must use the full ID to select the container
        document.getElementById(tabName + '-tab').classList.remove('hidden'); 
    });

</script>
</body>
</html>

