<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lodge Financial Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .balance-positive {
            color: #10b981; /* Green-500 */
        }
        .balance-negative {
            color: #ef4444; /* Red-500 */
        }
        /* Error Box Styling */
        .fatal-error-box {
            background-color: #fee2e2; /* Red-100 */
            color: #dc2626; /* Red-600 */
            border: 1px solid #fca5a5; /* Red-300 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="flex flex-col sm:flex-row justify-between items-center container mx-auto">
            <h1 class="text-xl font-bold text-gray-800 mb-2 sm:mb-0">Lodge Financial Admin</h1>
            <span id="auth-status" class="text-sm text-gray-500">Status: Connecting...</span>
        </div>
    </div>

    <div class="bg-gray-100 p-2 shadow-inner sticky top-16 z-10">
        <!-- Tab Buttons (Controls) -->
        <div class="flex justify-around container mx-auto" id="tab-controls">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="roster">Dues Roster</button>
            <button class="tab-button" data-tab="expenses">Expenses</button>
        </div>
    </div>

    <main class="container mx-auto mt-4">
        <div id="app-status-message">
            <!-- This is where the fatal error warning will be inserted -->
        </div>

        <!-- Tab Content Containers -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Financial Summary Card -->
                <div class="card p-4 col-span-1 lg:col-span-2">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h2 class="text-lg font-semibold">Financial Summary</h2>
                        <button id="print-summary-btn" class="py-1 px-3 text-sm rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition disabled:opacity-50" disabled>
                            Connecting...
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-gray-700">
                            <span>Total Dues Collected:</span>
                            <span id="total-dues" class="font-bold text-lg text-blue-600">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-gray-700">
                            <span>Total Expenses:</span>
                            <span id="total-expenses" class="font-bold text-lg text-red-500">-$0.00</span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t">
                            <span class="text-xl font-bold">Net Balance:</span>
                            <span id="net-balance" class="text-2xl font-extrabold balance-positive">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Expense Form Card -->
                <div class="card p-4 col-span-1">
                    <h2 class="text-lg font-semibold mb-3 border-b pb-2">Record New Expense</h2>
                    <form id="expense-form" class="space-y-3">
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                            <input type="number" step="0.01" id="expense-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="expense-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="expense-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <button type="submit" id="record-expense-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                            Connecting...
                        </button>
                    </form>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="card p-4 mt-6">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Recent Expenses</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Description</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recent-expenses-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="3" class="px-3 py-2 text-center text-sm text-gray-500">Loading recent expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="expense-message" class="mt-2 text-sm text-center text-gray-500 hidden">Showing last 5 expenses.</p>
            </div>

        </div>

        <div id="roster-tab" class="tab-content hidden">
            <!-- Dues Roster and Member Management -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Dues Roster</h2>
                
                <!-- Add Member Form -->
                <form id="add-member-form" class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-md font-medium mb-3">Add New Member</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="member-name" placeholder="Member Name" class="p-2 border rounded-md flex-grow" required>
                        <input type="number" id="annual-dues" placeholder="Annual Dues ($)" step="1" class="p-2 border rounded-md w-full sm:w-1/3" required value="100">
                        <button type="submit" id="add-member-btn" class="py-2 px-4 rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition disabled:opacity-50" disabled>Connecting...</button>
                    </div>
                </form>

                <!-- Roster Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Name</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Dues</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Paid This Year</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dues-roster-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-3 py-2 text-center text-sm text-gray-500">Loading roster...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="expenses-tab" class="tab-content hidden">
            <!-- Expense History -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Full Expense History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Description</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="full-expenses-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-3 py-2 text-center text-sm text-gray-500">Loading all expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal for Confirmations/Messages -->
    <div id="app-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirmation</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">Confirm</button>
            </div>
        </div>
    </div>


<!-- Simple, Non-Module Script for Tab Switching with Persistence -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabControls = document.getElementById('tab-controls');
        // Retrieve the last active tab from local storage, default to 'dashboard'
        const initialTab = localStorage.getItem('activeTab') || 'dashboard';

        // Function to handle the tab switch logic
        function switchTab(tabName) {
            // 1. Update button active state
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const targetButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // 2. Show/Hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                const contentId = content.id; // e.g., 'dashboard-tab'
                if (contentId === tabName + '-tab') {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // 3. Persist selection
            localStorage.setItem('activeTab', tabName);
        }

        // Apply initial tab state
        switchTab(initialTab);

        tabControls.addEventListener('click', function(e) {
            const target = e.target.closest('.tab-button');
            if (!target) return;

            const tabName = target.dataset.tab;
            switchTab(tabName);
        });
    });
</script>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Enable Firestore debug logging
    setLogLevel('Debug');

    // --- GLOBAL VARIABLES & CONFIG (Using Canvas Environment Vars) ---
    let app, db, auth, userId = null;
    let isAuthReady = false;

    // Use environment variables for Firebase configuration
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-lodge-admin-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // UI Elements
    const authStatusEl = document.getElementById('auth-status');
    const recordExpenseBtn = document.getElementById('record-expense-btn');
    const addMemberBtn = document.getElementById('add-member-btn');
    const appStatusMessage = document.getElementById('app-status-message');
    const printSummaryBtn = document.getElementById('print-summary-btn');

    // --- UTILITIES ---

    // Sets the status/readiness of all primary action buttons
    function setFormStatus(ready, text) {
        if (ready) {
            recordExpenseBtn.disabled = false;
            recordExpenseBtn.textContent = 'Record Expense';
            addMemberBtn.disabled = false;
            addMemberBtn.textContent = 'Add Member';
            printSummaryBtn.disabled = false;
            printSummaryBtn.textContent = 'Print Accounting Summary';
        } else {
            // Disable forms and set loading text
            recordExpenseBtn.disabled = true;
            recordExpenseBtn.textContent = text;
            addMemberBtn.disabled = true;
            addMemberBtn.textContent = text;
            printSummaryBtn.disabled = true;
            printSummaryBtn.textContent = text;
        }
    }

    // Simple Modal/Confirmation
    const modalEl = document.getElementById('app-modal');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMessageEl = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    function showModal(title, message, onConfirm) {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalEl.classList.remove('hidden');

        // Clear previous listeners
        modalConfirmBtn.onclick = null;
        modalCancelBtn.onclick = null;

        // Set new listeners
        modalConfirmBtn.onclick = () => {
            onConfirm();
            modalEl.classList.add('hidden');
        };
        modalCancelBtn.onclick = () => {
            modalEl.classList.add('hidden');
        };
    }

    function showFatalError(message, authError = null) {
        let rulesTip = '';
        if (authError) {
            rulesTip = `<p class="mt-2 text-xs font-semibold">Auth Code: ${authError.code || 'N/A'}</p>`;
        }

        appStatusMessage.innerHTML = `
            <div class="fatal-error-box">
                <p class="text-xl font-bold mb-2">FATAL ERROR: Initialization failed.</p>
                <p class="text-sm">${message}</p>
                ${rulesTip}
            </div>
        `;
        authStatusEl.textContent = "Status: Config Error";
        setFormStatus(false, "Config Error");
        console.error("FATAL ERROR:", message, authError);
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
        }).format(amount);
    }

    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
    
    if (!firebaseConfig) {
        showFatalError("Firebase configuration is missing. The environment variable __firebase_config was not found or is invalid.");
        return; // Stop execution
    }

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app); 
        auth = getAuth(app);
        console.log("Firebase App Initialized.");
        setFormStatus(false, "Authenticating..."); // Set initial status
    } catch (e) {
        showFatalError("Firebase configuration is invalid or failed to initialize.", e);
        console.error("Firebase Initialization Error:", e);
        return;
    }

    async function authenticate() {
        try {
            authStatusEl.textContent = "Status: Authenticating...";
            await setPersistence(auth, browserSessionPersistence);
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            // onAuthStateChanged will handle the rest
        } catch (error) {
            showFatalError(`Authentication failed. Check your Firebase Project ID and Firestore Security Rules.`, error);
            setFormStatus(false, "Auth Failed");
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            isAuthReady = true;
            // Use the first 8 characters of the userId for display
            authStatusEl.textContent = `Status: Logged in (User ID: ${userId})`; 
            setFormStatus(true, "Ready"); // Forms are now active
            console.log("User signed in. UID:", userId);
            
            document.getElementById('app-status-message').innerHTML = ''; 
            
            // Start listening for data now that we have a user
            setupAllListeners();

        } else {
            userId = null;
            isAuthReady = false;
            authStatusEl.textContent = "Status: Signed out.";
            setFormStatus(false, "Signed Out");
        }
    });

    authenticate(); // Kick off the process


    // --- FIREBASE PATHS ---

    // Public collection path: /artifacts/{appId}/public/data/{collectionName}
    function getPublicCollectionRef(collectionName) {
        // Data is public/shared, so it goes under the public path
        return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
    }
    
    // --- DATA LISTENERS AND RENDERING ---

    let totalDues = 0;
    let totalExpenses = 0;
    // Store data globally to be available for the print function
    let memberRoster = [];
    let expenseHistory = [];

    function setupAllListeners() {
        if (!isAuthReady) return;
        
        setupFinancialSummaryListener();
        setupRosterListener();
        setupExpenseHistoryListener();
        attachPrintButtonListener(); // Attach print button handler
    }

    // 1. FINANCIAL SUMMARY (Dashboard & Totals)
    function setupFinancialSummaryListener() {
        // Listen for all dues (Members)
        const rosterRef = getPublicCollectionRef('members');
        onSnapshot(rosterRef, (snapshot) => {
            totalDues = 0;
            memberRoster = [];
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                if (data.paidThisYear) {
                    totalDues += data.paidThisYear;
                }
                memberRoster.push({...data, id: doc.id});
            });
            renderFinancialSummary();
            renderRoster(memberRoster); // Rerender roster on update
        }, (error) => console.error("Dues Listener Error:", error));

        // Listen for all expenses
        const expensesRef = getPublicCollectionRef('expenses');
        onSnapshot(expensesRef, (snapshot) => {
            totalExpenses = 0;
            expenseHistory = [];
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                totalExpenses += data.amount;
                expenseHistory.push({...data, id: doc.id});
            });
            renderFinancialSummary();
            renderRecentExpenses(expenseHistory);
            renderFullExpenseHistory(expenseHistory); // Rerender full list on update
        }, (error) => console.error("Expenses Listener Error:", error));
    }

    function renderFinancialSummary() {
        const netBalance = totalDues - totalExpenses;
        
        document.getElementById('total-dues').textContent = formatCurrency(totalDues);
        document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);

        const netBalanceEl = document.getElementById('net-balance');
        netBalanceEl.textContent = formatCurrency(netBalance);
        
        // Highlight balance color
        netBalanceEl.classList.remove('balance-positive', 'balance-negative');
        if (netBalance >= 0) {
            netBalanceEl.classList.add('balance-positive');
        } else {
            netBalanceEl.classList.add('balance-negative');
        }
    }

    function renderRecentExpenses(expensesData) {
        const body = document.getElementById('recent-expenses-body');
        body.innerHTML = '';

        // Sort by date/timestamp descending and show top 5
        const sortedExpenses = expensesData.sort((a, b) => 
            (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)
        ).slice(0, 5);

        if (sortedExpenses.length === 0) {
            body.innerHTML = `<tr><td colspan="3" class="px-3 py-2 text-center text-sm text-gray-500">No expenses recorded yet.</td></tr>`;
            document.getElementById('expense-message').classList.add('hidden');
            return;
        }

        sortedExpenses.forEach(expense => {
            const date = expense.timestamp ? new Date(expense.timestamp.toMillis()).toLocaleDateString() : 'N/A';
            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-700">${expense.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-red-500">
                        -${formatCurrency(expense.amount)}
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });
        document.getElementById('expense-message').classList.remove('hidden');
    }

    // 2. ROSTER (DUES) MANAGEMENT

    function setupRosterListener() {
        // Listener is integrated into setupFinancialSummaryListener to update totalDues and memberRoster
    }

    function renderRoster(rosterData) {
        const body = document.getElementById('dues-roster-body');
        body.innerHTML = '';

        if (rosterData.length === 0) {
            body.innerHTML = `<tr><td colspan="5" class="px-3 py-2 text-center text-sm text-gray-500">No members added yet.</td></tr>`;
            return;
        }

        rosterData.forEach(member => {
            const statusClass = member.paidThisYear >= member.annualDues ? 'text-green-600 font-semibold' : 'text-red-500';
            const statusText = member.paidThisYear >= member.annualDues ? 'PAID' : 'DUE';
            
            const remainingDue = member.annualDues - (member.paidThisYear || 0); // Use 0 if paidThisYear is null/undefined
            const payButtonText = remainingDue > 0 ? `Pay ${formatCurrency(remainingDue)}` : 'Fully Paid';

            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${member.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-700">${formatCurrency(member.annualDues)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-blue-600 font-medium">${formatCurrency(member.paidThisYear || 0)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center ${statusClass}">${statusText}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center">
                        <button data-id="${member.id}" data-due="${remainingDue}" class="pay-dues-btn py-1 px-3 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 transition disabled:opacity-50" ${remainingDue <= 0 ? 'disabled' : ''}>
                            ${payButtonText}
                        </button>
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });

        // Add event listeners for pay buttons
        document.querySelectorAll('.pay-dues-btn').forEach(button => {
            button.addEventListener('click', function() {
                const memberId = this.dataset.id;
                const remainingDue = parseFloat(this.dataset.due);
                handleDuesPayment(memberId, remainingDue);
            });
        });
    }
    
    async function handleDuesPayment(memberId, remainingDue) {
        if (!isAuthReady) return;

        showModal(
            "Record Dues Payment", 
            `Confirm receipt of ${formatCurrency(remainingDue)} from this member.`,
            async () => {
                try {
                    const memberDocRef = doc(getPublicCollectionRef('members'), memberId);
                    const currentData = (await getDoc(memberDocRef)).data();
                    const newPaidTotal = (currentData.paidThisYear || 0) + remainingDue;

                    await updateDoc(memberDocRef, {
                        paidThisYear: newPaidTotal,
                        lastPaid: serverTimestamp()
                    });
                    console.log("Dues payment recorded successfully.");
                } catch (e) {
                    console.error("Error recording dues payment:", e);
                    showModal("Error", "Could not record payment. Check console for details.", () => {});
                }
            }
        );
    }
    
    // 3. EXPENSE HISTORY (Full List)
    function setupExpenseHistoryListener() {
        // Listener is integrated into setupFinancialSummaryListener to update totalExpenses and expenseHistory
    }

    function renderFullExpenseHistory(expensesData) {
        const body = document.getElementById('full-expenses-body');
        body.innerHTML = '';

        // Sort in-memory (descending)
        const sortedExpenses = expensesData.sort((a, b) => 
            (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)
        );

        if (sortedExpenses.length === 0) {
            body.innerHTML = `<tr><td colspan="4" class="px-3 py-2 text-center text-sm text-gray-500">No expenses recorded yet.</td></tr>`;
            return;
        }

        sortedExpenses.forEach(expense => {
            const date = expense.timestamp ? new Date(expense.timestamp.toMillis()).toLocaleDateString() : 'N/A';
            const row = `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-700">${expense.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-red-500">
                        -${formatCurrency(expense.amount)}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center">
                        <button data-id="${expense.id}" class="delete-expense-btn text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H4.25a.75.75 0 0 0 0 1.5h.5c.343 0 .67.142.905.39l.006.007.41 1.708a2.5 2.5 0 0 0 4.658 0l.41-1.708.006-.007a1.751 1.751 0 0 0 .905-.39h.5a.75.75 0 0 0 0-1.5H14v-.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM9 3.75v.5h2v-.5A1.25 1.25 0 0 0 9.75 2.5h-1.5A1.25 1.25 0 0 0 7 3.75v.5h2Zm-3.25 7a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H5.75Zm9.25 0a.75.75 0 0 0 0 1.5h-.008a.75.75 0 0 0 0-1.5H15Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
            body.innerHTML += row;
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-expense-btn').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.dataset.id;
                confirmDeleteExpense(expenseId);
            });
        });
    }

    function confirmDeleteExpense(expenseId) {
        if (!isAuthReady) return;

        showModal(
            "Confirm Deletion",
            "Are you sure you want to permanently delete this expense record?",
            async () => {
                try {
                    const expenseDocRef = doc(getPublicCollectionRef('expenses'), expenseId);
                    await deleteDoc(expenseDocRef);
                    console.log("Expense deleted successfully.");
                } catch (e) {
                    console.error("Error deleting expense:", e);
                    showModal("Error", "Could not delete expense. Check console for details.", () => {});
                }
            }
        );
    }


    // --- PRINTABLE SUMMARY FUNCTIONALITY ---

    function generatePrintSummary() {
        if (!isAuthReady) {
            showModal("Error", "Please wait for the application to fully connect before generating a report.", () => {});
            return;
        }

        const netBalance = totalDues - totalExpenses;
        
        // --- 1. Compile Roster Data (from live data) ---
        const rosterRows = memberRoster.map(m => {
            const statusText = m.paidThisYear >= m.annualDues ? 'PAID' : 'DUE';
            return `
                <tr>
                    <td class="p-2">${m.name}</td>
                    <td class="p-2 text-center">${formatCurrency(m.annualDues)}</td>
                    <td class="p-2 text-center text-blue-600">${formatCurrency(m.paidThisYear || 0)}</td>
                    <td class="p-2 text-center ${m.paidThisYear >= m.annualDues ? 'text-green-600 font-bold' : 'text-red-500'}">${statusText}</td>
                </tr>
            `;
        }).join('');


        // --- 2. Compile Expense Data (from live data, sorted by date DESC) ---
        const sortedExpenses = [...expenseHistory].sort((a, b) => 
            (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)
        );

        const expenseRows = sortedExpenses.map(e => {
            const date = e.timestamp ? new Date(e.timestamp.toMillis()).toLocaleDateString() : 'N/A';
            return `
                <tr>
                    <td class="p-2 w-1/4">${date}</td>
                    <td class="p-2 w-1/2">${e.description}</td>
                    <td class="p-2 text-right text-red-500 font-medium">-${formatCurrency(e.amount)}</td>
                </tr>
            `;
        }).join('');

        // 3. Build the HTML Content
        const summaryHTML = `
            <div class="p-8 bg-white min-h-screen">
                <h1 class="text-3xl font-bold mb-6 border-b-4 border-indigo-600 pb-2">Lodge Financial Report - ${new Date().toLocaleDateString()}</h1>
                <p class="text-sm text-gray-500 mb-6">Generated by User ID: ${userId}</p>

                <!-- Summary Section -->
                <div class="mb-8 p-4 border rounded-lg bg-gray-50 print-bg-white">
                    <h2 class="text-xl font-semibold mb-3">Overall Financial Status</h2>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-3 border rounded bg-white">
                            <p class="text-sm text-gray-500">Total Dues Collected</p>
                            <p class="text-2xl font-bold text-blue-600">${formatCurrency(totalDues)}</p>
                        </div>
                        <div class="p-3 border rounded bg-white">
                            <p class="text-sm text-gray-500">Total Expenses</p>
                            <p class="text-2xl font-bold text-red-600">${formatCurrency(totalExpenses)}</p>
                        </div>
                        <div class="p-3 border rounded bg-white">
                            <p class="text-sm text-gray-500">Net Balance</p>
                            <p class="text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(netBalance)}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Dues Status -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3 border-b pb-1">Member Dues Status</h2>
                    <table class="min-w-full border divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Member Name</th>
                                <th class="p-2 text-center">Annual Dues</th>
                                <th class="p-2 text-center">Paid YTD</th>
                                <th class="p-2 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rosterRows}
                        </tbody>
                    </table>
                </div>

                <!-- Expense History -->
                <div>
                    <h2 class="text-xl font-semibold mb-3 border-b pb-1">Expense History</h2>
                    <table class="min-w-full border divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left w-1/4">Date</th>
                                <th class="p-2 text-left w-1/2">Description</th>
                                <th class="p-2 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${expenseRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // 4. Open in New Window and Print
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Lodge Financial Summary</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
                    body { margin: 0; background-color: #ffffff !important; font-family: 'Inter', sans-serif; }
                    
                    /* Ensures tables and borders print cleanly */
                    table { border-collapse: collapse; }
                    .print-bg-white { background-color: #ffffff !important; }

                    @media print {
                        /* Important: Force background colors for headers/cards if needed */
                        .bg-gray-50 { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: #f9fafb !important; }
                        .text-red-600 { color: #dc2626 !important; }
                        .text-green-600 { color: #059669 !important; }
                        .text-blue-600 { color: #2563eb !important; }
                    }
                </style>
            </head>
            <body>
                ${summaryHTML}
            </body>
            </html>
        `);
        printWindow.document.close();

        // Wait for content to load, then trigger print dialog
        printWindow.onload = function() {
            printWindow.print();
        };
    }

    function attachPrintButtonListener() {
        const printBtn = document.getElementById('print-summary-btn');
        if (printBtn) {
            printBtn.addEventListener('click', generatePrintSummary);
        }
    }


    // --- FORM SUBMISSIONS ---

    // Expense Form
    document.getElementById('expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isAuthReady) return;

        const amount = parseFloat(document.getElementById('expense-amount').value);
        const description = document.getElementById('expense-description').value.trim();

        if (amount <= 0 || !description) {
            showModal("Error", "Please enter a valid amount and description.", () => {});
            return;
        }

        try {
            await addDoc(getPublicCollectionRef('expenses'), {
                amount: amount,
                description: description,
                timestamp: serverTimestamp(),
                recordedBy: userId
            });
            this.reset();
            console.log("Expense recorded successfully.");
        } catch (e) {
            console.error("Error recording expense:", e);
            showModal("Error", "Could not record expense. Check console for details.", () => {});
        }
    });

    // Add Member Form
    document.getElementById('add-member-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isAuthReady) return;

        const name = document.getElementById('member-name').value.trim();
        const annualDues = parseFloat(document.getElementById('annual-dues').value);

        if (!name || annualDues <= 0) {
            showModal("Error", "Please enter a valid member name and annual dues amount.", () => {});
            return;
        }

        try {
            // Check if member already exists (simple name check)
            const membersRef = getPublicCollectionRef('members');
            const q = query(membersRef, where('name', '==', name));
            const existing = await getDocs(q);

            if (!existing.empty) {
                showModal("Error", `A member named "${name}" already exists.`, () => {});
                return;
            }

            await addDoc(membersRef, {
                name: name,
                annualDues: annualDues,
                paidThisYear: 0,
                joinedDate: serverTimestamp()
            });
            this.reset();
            console.log("Member added successfully.");
        } catch (e) {
            console.error("Error adding member:", e);
            showModal("Error", "Could not add member. Check console for details.", () => {});
        }
    });

</script>
</body>
</html>

